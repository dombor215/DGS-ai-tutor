<!DOCTYPE html><html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DGS AI Tutor</title>
<style>
  :root {
    --primary-color: #4A90E2;
    --secondary-color: #357ABD;
    --user-bg: #d1e7dd;
    --bot-bg: #ffffff;
    --background: #f5f7fa;
    --border-radius: 12px;
    --shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    --shadow-hover: 0 4px 16px rgba(0, 0, 0, 0.12);
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
    display: flex;
    flex-direction: column;
    height: 100vh;
    margin: 0;
    background: var(--background);
  }

  header {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 24px 20px;
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 16px rgba(0, 0, 0, 0.15);
    position: relative;
  }

  .copyright {
    font-size: 12px;
    font-weight: 400;
    margin-top: 8px;
    opacity: 0.9;
  }

  .copyright a {
    color: white;
    text-decoration: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.5);
  }

  .copyright a:hover {
    border-bottom: 1px solid white;
  }

  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .message {
    margin: 0;
    padding: 14px 18px;
    border-radius: var(--border-radius);
    max-width: 70%;
    box-shadow: var(--shadow);
    line-height: 1.6;
    word-wrap: break-word;
    animation: fadeIn 0.3s ease-in;
    font-size: 15px;
  }

  .user {
    background: var(--user-bg);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
    white-space: pre-wrap;
  }

  .bot {
    background: var(--bot-bg);
    border: 1px solid #e0e0e0;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }

  /* Markdown styling for bot messages */
  .bot h1, .bot h2, .bot h3, .bot h4 {
    margin: 16px 0 8px 0;
    color: var(--secondary-color);
    line-height: 1.3;
  }

  .bot h1 { font-size: 1.5em; font-weight: 700; }
  .bot h2 { font-size: 1.3em; font-weight: 700; }
  .bot h3 { font-size: 1.1em; font-weight: 600; }
  .bot h4 { font-size: 1em; font-weight: 600; }

  .bot h1:first-child, .bot h2:first-child, .bot h3:first-child, .bot h4:first-child {
    margin-top: 0;
  }

  .bot p {
    margin: 8px 0;
  }

  .bot p:first-child {
    margin-top: 0;
  }

  .bot p:last-child {
    margin-bottom: 0;
  }

  .bot ul, .bot ol {
    margin: 8px 0;
    padding-left: 24px;
  }

  .bot ul li, .bot ol li {
    margin: 4px 0;
  }

  .bot ul {
    list-style-type: disc;
  }

  .bot ol {
    list-style-type: decimal;
  }

  .bot strong {
    font-weight: 600;
  }

  .bot em {
    font-style: italic;
    color: #555;
  }

  .bot code {
    background: #f4f4f4;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    color: #d63384;
  }

  .bot pre {
    background: #f4f4f4;
    padding: 12px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 8px 0;
  }

  .bot pre code {
    background: none;
    padding: 0;
    color: inherit;
  }

  .bot blockquote {
    border-left: 4px solid var(--primary-color);
    padding-left: 12px;
    margin: 8px 0;
    color: #666;
    font-style: italic;
  }

  .bot a {
    color: var(--primary-color);
    text-decoration: none;
  }

  .bot a:hover {
    text-decoration: underline;
  }

  .bot hr {
    border: none;
    border-top: 1px solid #e0e0e0;
    margin: 12px 0;
  }

  #inputArea {
    display: flex;
    align-items: flex-end;
    padding: 16px;
    background: #fff;
    border-top: 1px solid #e0e0e0;
    gap: 10px;
    box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.05);
  }

  #messageInput {
    flex: 1;
    padding: 12px 14px;
    font-size: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    outline: none;
    transition: border 0.2s ease, box-shadow 0.2s ease;
    resize: none;
    overflow-y: auto;
    font-family: inherit;
    line-height: 1.5;
    max-height: 150px;
    min-height: 44px;
  }

  #messageInput:focus {
    border: 2px solid var(--primary-color);
    box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
  }

  .button-group {
    display: flex;
    gap: 8px;
    align-items: flex-end;
  }

  button {
    padding: 12px 16px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 18px;
    transition: background 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
    box-shadow: var(--shadow);
    min-width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  button:hover {
    background: var(--secondary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-hover);
  }

  button:active {
    transform: translateY(0);
  }

  #sendBtn, #apiBtn, #exportBtn, #importBtn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  }

  /* #apiBtn, #exportBtn, #importBtn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  } */

  /* #apiBtn:hover, #exportBtn:hover, #importBtn:hover {
    background: #5a6268;
  } */

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Scrollbar styling */
  #chat::-webkit-scrollbar {
    width: 8px;
  }

  #chat::-webkit-scrollbar-track {
    background: #f1f1f1;
  }

  #chat::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }

  #chat::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }

  /* Responsive adjustments */
  @media (max-width: 600px) {
    header {
      font-size: 20px;
      padding: 20px 16px;
    }

    #chat {
      padding: 16px;
    }

    .message {
      max-width: 85%;
      font-size: 14px;
    }

    #messageInput {
      font-size: 14px;
    }

    button {
      padding: 10px 12px;
      font-size: 16px;
      min-width: 40px;
      height: 40px;
    }

    #inputArea {
      padding: 12px;
      gap: 8px;
    }
  }
</style>
</script></head>
<body>
<header id="pageHeader">
  <span id="headerTitle">DGS AI Tutor</span>
  <div class="copyright">¬© 2025 Dominik Borovsk√Ω & Jozef Hanƒç, v1.0</div> <!--[<a href="https://github.com/dombor215/DGS-ai-tutor" target="https://github.com/dombor215/DGS-ai-tutor">Github page</a>]-->
</header>
<div id="chat"></div>
<div id="inputArea">
    <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
    <div class="button-group">
      <button id="sendBtn" title="Send message" onclick="sendMessage()">‚û§</button>
      <button id="apiBtn" title="Set key" onclick="setApiKey()">üîë</button>
      <button id="exportBtn" title="Save chat">üíæ</button>
      <button id="importBtn" title="Import chat">üìÇ</button>
    </div>
</div>

<script>
// Initialize chat when DOM is ready
let sessionStartTime = null;

window.addEventListener("DOMContentLoaded", () => {
  sessionStartTime = new Date().toISOString();
  document.getElementById("headerTitle").textContent = "DGS AI Tutor";
  addMessage(FIRST_MESSAGE, "bot");
});

// --- Chat Logic ---
const API_URL = "https://api.poe.com/v1/chat/completions";
const MODEL_NAME = "Assistant";
const API_FIRST_PART = "bYfK1g8qs5jyqobpNkxCvgDXw0RSKnMaCbXzD5x";
const MATERIAL_LINK = "https://drive.google.com/file/d/12FBYjTioecWkyYInHpm368yGqflrb5sq/view?usp=sharing"
const FIRST_MESSAGE = `Vitaj v prostred√≠ AI t√∫tora predmetu Digit√°lna gramotnos≈• ≈°tudenta. Cieƒæom tohto chatbota je postupne ≈•a previes≈• diskusiou o umelej inteligencii. Pred zaƒçiatkom tejto diskusie nezabudni:

* pre≈°tudova≈• si [**materi√°l**](${MATERIAL_LINK}) z Google triedy 
* vlo≈æi≈• kƒæ√∫ƒç üîë, ktor√Ω m√°≈° od vyuƒçuj√∫cich predmetu
* po ukonƒçen√≠ si ulo≈æi≈• konverz√°ciu pomocou üíæ (stiahne sa .json s√∫bor)
* ak sa chce≈° ku konverz√°cii vr√°ti≈•, m√¥≈æe≈° uploadova≈• stiahnut√Ω .json pomocou üìÇ
**POZOR:** po zatvoren√≠ okna sa konverz√°cia vyma≈æe.
`
const CONTENT_USER = `
Si asistent uƒçiteƒæa a t√∫tor ≈°tudentov na vysokej ≈°kole. Tvojou √∫lohou je vies≈• diskusiu so ≈°tudentom na uveden√© t√©my, priƒçom poƒças diskusie m√°≈° pokry≈• v≈°etky t√©my z nasleduj√∫ceho zoznamu. 

* Odpovede form√°tuj v Markdown.
* Na zaƒçiatku sa pozdrav a predstav sa ako AI t√∫tor v r√°mci predmetu Digit√°lna gramotnos≈• ≈°tudenta, ktor√©ho √∫lohou je vies≈• diskusiu so ≈°tudentom o ≈°tudijnom materi√°li z Google triedy o umelej inteligencii.
* Potom zaƒçni prech√°dza≈• jednotliv√Ωmi t√©mami. Poskytni ≈°tudentovi t√©mu tak, ako to je nap√≠san√©, t.j. kr√°tky √∫vod a n√°sledn√© ot√°zky.
* Veƒè ≈°tudenta diskusiou a v≈ædy skontroluj, ƒçi boli zodpovedan√© v≈°etky ot√°zky v r√°mci danej t√©my. Ak nie, tak sa o tom zmie≈à a vyzvi ≈°tudenta, aby svoju odpoveƒè doplnil.
* Priebe≈æne poskytuj kr√°tku sp√§tn√∫ v√§zbu na odpovede, ktor√© ≈°tudent nap√≠sal, a tie≈æ reakciu. Predt√Ωm, ne≈æ prejde≈° na ƒèal≈°iu t√©mu, m√¥≈æe≈° polo≈æi≈• dopl≈àuj√∫cu ot√°zku ohƒæadom ≈°tudentovej odpovede - prejav z√°ujem o to, ƒço rozpr√°va ≈°tudent.
* Ak je nieƒço hrubo nespr√°vne, m√¥≈æe≈° ≈°tudenta opravi≈•. Tvoj t√≥n nech je ale priateƒæsk√Ω a nech vyvol√°va podporu, nebuƒè ale pr√≠li≈° vtierav√Ω.
* Motivuj ≈°tudenta k tomu, aby poƒças diskusie vyjadril svoj n√°zor. Ak s√∫ ≈°tudentove odpovede pr√≠li≈° kr√°tke alebo sa zdaj√∫ neautentick√©, poskytni mu dopl≈àuj√∫ce ot√°zky.
* Po prediskutovan√≠ v≈°etk√Ωch 6 t√©m prejdi na kr√°tku sp√§tn√∫ v√§zbu, ako diskusia prebehla, ak√Ω m√° ≈°tudent prehƒæad o t√©me AI a ako by sa mohol ƒèalej zlep≈°ova≈• alebo mohol z√≠skava≈• nov√© inform√°cie. Na z√°ver zhodno≈• ≈°tudentovu diskusiu, ƒçi boli jeho postrehy autentick√©, ƒçi boli jeho odpovede dostatoƒçne prepracovan√©.
* Poskytni na z√°ver sum√°rne hodnotenie v tvare: "**Hodnotenie diskusie:** [v√Ωborn√°/veƒæmi dobr√°/dobr√°/podstaƒçuj√∫ca/nepostaƒçuj√∫ca]"
* Po poskytnut√≠ hodnotenia pripome≈à ≈°tudentovi, aby si nezabudol ulo≈æi≈• konverz√°ciu (ikonka diskety üíæ, spust√≠ sa s≈•ahovanie json s√∫boru), a odovzda≈• ju k zadaniu v Google Triede.
* Rozl√∫ƒç sa so ≈°tudentom a daj mu in≈°trukciu, ≈æe m√¥≈æe √≠s≈•.

## Krit√©ri√° hodnotenia
* V√Ωborn√° - V≈°etky t√©my pokryt√©, odpovede autentick√©, prepracovan√©, ≈°tudent preuk√°zal hlbok√© porozumenie
* Veƒæmi dobr√° - V≈°etky t√©my pokryt√©, v√§ƒç≈°ina odpoved√≠ prepracovan√°, obƒçasn√© potreby dopl≈àuj√∫cich ot√°zok
* Dobr√° - V≈°etky t√©my pokryt√©, odpovede struƒçn√© ale relevantn√©
* Podstaƒçuj√∫ca - Niektor√© t√©my pokryt√© povrchne, ≈°tudent potreboval v√Ωrazn√© vedenie
* Nepostaƒçuj√∫ca - ≈†tudent sa vyh√Ωbal t√©mam alebo poskytoval irelevantn√© odpovede

## Zoznam t√©m

### T√©ma 1: Podstata a dopady ChatGPT

Zo ≈°tudijn√©ho materi√°lu si sa mohol/-la dozvedie≈• o tom, ak√Ω v√Ωznam maj√∫ AI chatboty pre spoloƒçnos≈• a ƒço sa za nimi skr√Ωva. 

* ƒåo ChatGPT znamen√° pre teba?
* ƒåo si predstavuje≈° pod pojmom ChatGPT? 

### T√©ma 2: Zodpovednos≈• pri pou≈æ√≠van√≠ AI

≈†tudijn√Ω text v kr√°tkosti reflektuje aj etick√∫ ot√°zku pou≈æ√≠vania AI chatbotov, ƒçi u≈æ ƒço sa t√Ωka mo≈æn√Ωch riz√≠k alebo spr√°vnosti obsahu, ktor√Ω generuj√∫. 

* V ƒçom vid√≠≈° mo≈æn√© rizik√° ty? 
* Narazil/-a si na nejak√© zauj√≠mav√© pr√≠pady (vlastn√° sk√∫senos≈• alebo m√©di√°), keƒè sa chatbot oƒçividne m√Ωli, "halucinuje" alebo m√¥≈æe by≈• nebezpeƒçn√Ω? Ak√© to boli?

### T√©ma 3: ChatGPT a jeho alternat√≠vy. 
Poskytnut√Ω ≈°tudijn√Ω text v kr√°tkosti zmie≈àuje aj chatboty od r√¥znych in√Ωch spoloƒçnost√≠ okrem notoricky zn√°meho ChatGPT. 

* Pou≈æ√≠va≈° ChatGPT alebo nejak√© jeho alternat√≠vy?
* Boli ti niektor√© z alternat√≠vnych chatbotov zn√°me u≈æ predt√Ωm? Pozn√°≈° nejak√© in√©, ktor√© neboli zmienen√© v texte?
* Plat√≠≈° za pou≈æ√≠vanie AI alebo vyu≈æ√≠va≈° len "free" mo≈ænosti?
* Zauj√≠ma ≈•a, kto stoj√≠ za chatbotom (firma, krajina)? Ovplyv≈àuje to tvoju voƒæbu?

### T√©ma 4: Ako pou≈æ√≠vam AI n√°stroje. 

≈†tudijn√Ω text zmie≈àuje aj rozliƒçn√© konkr√©tne sc√©nare pou≈æitia AI alebo konkr√©tne proced√∫ry, ako je pr√°ca s PDF dokumentami, vyhƒæad√°vanie webov√Ωch zdrojov na mieru alebo pokroƒçil√© met√≥dy p√≠sania v√Ωziev. 

* Je ti nejak√Ω z poskytnut√Ωch sc√©narov zn√°my alebo naopak, bol pre teba niektor√Ω z nich √∫pln√Ωm prekvapen√≠m?
* Vie≈° nieƒço doplni≈• zo svojej vlastnej sk√∫senosti?
* Na ƒço najƒçastej≈°ie pou≈æ√≠va≈° AI ty?

### T√©ma 5: Pokroƒçilej≈°ie p√≠sanie v√Ωziev. 
V poskytnutom texte sa zmie≈àujeme aj o pokroƒçil√Ωch met√≥dach p√≠sania v√Ωziev - promptov. Pou≈æ√≠val/-a si niekedy predt√Ωm, vedome ƒçi nevedome, niektor√© z nich, napr. Few-Shot-Prompting (poskytnutie vzorov√©ho pr√≠kladu) alebo PARTS (cel√Ω alebo jeho ƒçasti)? Ktor√∫ z nich pova≈æuje≈° za naju≈æitoƒçnej≈°iu pre teba a v ak√Ωch situ√°ci√°ch? Ako by si zhodnotil/-a "kvalitu" alebo "pokroƒçilos≈•" svojich promptov?

### T√©ma 6: Mutlimodalita a obsah komunik√°cie s AI. 

Jednou z t√©m textu bola multimodalita AI n√°strojov, t.j. mo≈ænos≈• prij√≠mania vstupov a poskytovania v√Ωstupov v rozliƒçn√Ωch form√°toch - text, obr√°zky, zvuk (hovoren√° reƒç, hudba a pod.), video, rozliƒçn√© dokumenty. ≈†tandardne sa stret√°vame s dvojicou vstup-v√Ωstup v podobe text-text (nap√≠≈°e≈° text a dostane≈° odpoveƒè v podobe textu). 

* Sk√∫≈°al/-a si niekedy interakciu s AI v inej kombin√°cii vstup-v√Ωstup?
* Ak √°no, ak√° dvojica to bola, ak√Ω AI n√°stroj si na to vyu≈æil/-a a v akej situ√°cii je pre teba u≈æitoƒçn√°?
* Ak nie, vie≈° si predstavi≈•, kedy s√∫ u≈æitoƒçn√© aj in√© kombin√°cie ako len text-text?

## Zabr√°nenie zneu≈æitiu

* Ak sa bude konverz√°cia t√Ωka≈• inej t√©my ne≈æ s√∫ AI n√°stroje, slu≈°ne vyzvi ≈°tudenta k tomu, aby sa vr√°til k t√©me a pripome≈à mu svoj √∫ƒçel.
`;


const chatBox = document.getElementById("chat");
const input = document.getElementById("messageInput");

// Allow sending messages by pressing Enter and newlines with Shift+Enter
input.addEventListener("keydown", (event) => {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
  // Shift+Enter inserts newline naturally
});

// Dynamic resizing of textarea with max-height constraint
input.addEventListener("input", () => {
  input.style.height = "auto";
  const newHeight = Math.min(input.scrollHeight, 150);
  input.style.height = newHeight + "px";
});

// Enhanced Markdown rendering function
function renderMarkdown(text) {
  // Escape HTML first
  let html = text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  // Process code blocks first (```code```)
  html = html.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');

  // Split into lines for processing
  const lines = html.split('\n');
  const processed = [];
  let inList = false;
  let listType = null;
  let listItems = [];

  for (let i = 0; i < lines.length; i++) {
    let line = lines[i];
    
    // Check for unordered list
    const ulMatch = line.match(/^[\s]*[\*\-]\s+(.+)$/);
    // Check for ordered list
    const olMatch = line.match(/^[\s]*\d+\.\s+(.+)$/);
    
    if (ulMatch || olMatch) {
      const content = ulMatch ? ulMatch[1] : olMatch[1];
      const currentType = ulMatch ? 'ul' : 'ol';
      
      if (!inList) {
        inList = true;
        listType = currentType;
        listItems = [];
      } else if (listType !== currentType) {
        // Different list type, close previous and start new
        processed.push(`<${listType}>${listItems.map(item => `<li>${item}</li>`).join('')}</${listType}>`);
        listItems = [];
        listType = currentType;
      }
      
      listItems.push(content);
    } else {
      // Not a list item
      if (inList) {
        // Close the list
        processed.push(`<${listType}>${listItems.map(item => `<li>${item}</li>`).join('')}</${listType}>`);
        inList = false;
        listType = null;
        listItems = [];
      }
      processed.push(line);
    }
  }
  
  // Close any open list at the end
  if (inList) {
    processed.push(`<${listType}>${listItems.map(item => `<li>${item}</li>`).join('')}</${listType}>`);
  }
  
  html = processed.join('\n');

  // Headers
  html = html.replace(/^#### (.+)$/gm, '<h4>$1</h4>');
  html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

  // Blockquotes
  html = html.replace(/^&gt;\s+(.+)$/gm, '<blockquote>$1</blockquote>');

  // Horizontal rules
  html = html.replace(/^[-*_]{3,}$/gm, '<hr>');

  // Bold
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');

  // Italic
  html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
  html = html.replace(/_(.+?)_/g, '<em>$1</em>');

  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  
  // Auto-link URLs (not already in links)
  html = html.replace(/(?<!href=")(?<!">)((?:https?:\/\/)[^\s<]+)/g, '<a href="$1" target="_blank">$1</a>');

  // Paragraphs (wrap non-tag lines)
  const finalLines = html.split('\n');
  const withParagraphs = [];
  
  for (let line of finalLines) {
    const trimmed = line.trim();
    if (trimmed === '') {
      withParagraphs.push('');
    } else if (trimmed.match(/^<(h[1-6]|ul|ol|pre|blockquote|hr)/)) {
      withParagraphs.push(line);
    } else if (!trimmed.match(/^<\/(ul|ol|li|blockquote)>$/)) {
      withParagraphs.push(`<p>${line}</p>`);
    } else {
      withParagraphs.push(line);
    }
  }

  return withParagraphs.join('\n');
}

function addMessage(content, sender) {
  const msg = document.createElement("div");
  msg.classList.add("message", sender);
  if (sender === "bot") {
    msg.innerHTML = renderMarkdown(content);
  } else {
    msg.textContent = content;
  }
  chatBox.appendChild(msg);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// local history of messages
let messages = [{ role: "system", content: CONTENT_USER }];

// Prompt-based API key entry
function setApiKey() {
  const key = prompt("Enter key:");
  if (key) {
    localStorage.setItem("api_key", key.trim());
    alert("Key saved.");
  }
}

// // Get saved API key
// function getApiKey() {
//   return localStorage.getItem("api_key");
// }

function getApiKey() {
  const key = localStorage.getItem("api_key");
  return key ? API_FIRST_PART + key : null;
}


// Sending user message
async function sendMessage() {
  const userMessage = input.value.trim();
  if (!userMessage) return;

  addMessage(userMessage, "user");
  messages.push({ role: "user", content: userMessage });
  input.value = "";
  input.style.height = "auto";

  const apiKey = getApiKey();
  if (!apiKey) {
    addMessage("‚ö†Ô∏è Please insert the key (click üîë).", "bot");
    return;
  }

  try {
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: messages
      })
    });

    const data = await response.json();
    const botReply = data.choices?.[0]?.message?.content || "No response.";
    addMessage(botReply, "bot");
    messages.push({ role: "assistant", content: botReply });
  } catch (error) {
    console.error("Error:", error);
    addMessage("‚ùå Error: Could not connect to API.", "bot");
  }
}

document.getElementById("exportBtn").addEventListener("click", () => {
  try {
    const exportData = {
      sessionStartTime: sessionStartTime,
      exportTime: new Date().toISOString(),
      messages: messages
    };
    const chatData = JSON.stringify(exportData, null, 2);
    const file = new Blob([chatData], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(file);
    a.download = "chat_export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  } catch (error) {
    console.error("Export failed:", error);
    alert("‚ùå Failed to export chat.");
  }
});

document.getElementById("importBtn").addEventListener("click", async () => {
  try {
    if (window.showOpenFilePicker) {
      const [fileHandle] = await window.showOpenFilePicker({
        types: [{ description: "JSON Files", accept: { "application/json": [".json"] } }],
        multiple: false
      });
      const file = await fileHandle.getFile();
      const text = await file.text();
      const importedData = JSON.parse(text);
      
      // Handle both old format (array) and new format (object with messages)
      const importedMessages = Array.isArray(importedData) ? importedData : (importedData.messages || []);
      
      if (Array.isArray(importedMessages)) {
        messages = importedMessages;
        chatBox.innerHTML = "";
        importedMessages.forEach(m => {
          if (m.role !== "system") {
            addMessage(m.content, m.role === "user" ? "user" : "bot");
          }
        });
      } else {
        alert("‚ùå Invalid chat file.");
      }
    } else {
      alert("‚ö†Ô∏è File import not supported in this browser.");
    }
  } catch (error) {
    console.error("Import failed:", error);
    alert("‚ùå Failed to import chat.");
  }
});
</script>



</body></html>
